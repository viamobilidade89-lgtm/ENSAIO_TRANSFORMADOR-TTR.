<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ensaios Alpha - TTR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #1a73e8; --success: #28a745; --danger: #dc3545; --gray: #6c757d; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; margin: 0; padding: 10px; }
        .wrapper { max-width: 800px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        label { display: block; font-weight: bold; font-size: 13px; margin-top: 10px; color: #444; }
        input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 5px; margin-top: 15px; flex-wrap: wrap; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; min-width: 120px; }
        
        .btn-calc { background: var(--success); }
        .btn-pdf { background: var(--primary); }
        .btn-clear { background: var(--gray); }
        .btn-unit { background: #555; font-size: 11px; padding: 5px; margin-bottom: 5px; }
        
        .results-box { background: #eef2f7; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .res-line { padding: 5px 0; border-bottom: 1px solid #ddd; font-family: monospace; }
        
        .history { font-size: 12px; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        h3 { margin-top: 0; color: var(--primary); font-size: 16px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="card">
        <header>
            <h1 style="margin:0; color: var(--primary);">Equipe Alpha - TTR</h1>
            <span style="font-size:12px; color: #777;">Cálculo de Resistência Corrigida</span>
        </header>

        <label>Temperatura Medida (°C)</label>
        <input id="tm" type="number" step="0.1" placeholder="Ex: 25.4">

        <div class="grid">
            <section>
                <h3>Entrada (Alta)</h3>
                <select id="unitIn">
                    <option value="1">Lido em Ω</option>
                    <option value="0.001">Lido em mΩ</option>
                </select>
                <input id="e1" type="text" placeholder="H1-H3">
                <input id="e2" type="text" placeholder="H1-H2">
                <input id="e3" type="text" placeholder="H2-H3">
                <button class="btn-unit" onclick="toggleDisplayUnit('In')">Mudar Unidade Resultado</button>
            </section>

            <section>
                <h3>Saída (Baixa)</h3>
                <select id="unitOut">
                    <option value="0.001">Lido em mΩ</option>
                    <option value="1">Lido em Ω</option>
                </select>
                <input id="s1" type="text" placeholder="X0-X1">
                <input id="s2" type="text" placeholder="X0-X2">
                <input id="s3" type="text" placeholder="X0-X3">
                <button class="btn-unit" onclick="toggleDisplayUnit('Out')">Mudar Unidade Resultado</button>
            </section>
        </div>

        <div class="btn-group">
            <button class="btn-calc" onclick="calcular()">CALCULAR</button>
            <button class="btn-clear" onclick="limpar()">LIMPAR</button>
            <button class="btn-pdf" onclick="gerarPDF()">GERAR PDF</button>
        </div>
    </div>

    <div class="card results-box" id="areaResultados" style="display:none;">
        <h3>Resultados Atuais</h3>
        <div id="resFinal"></div>
    </div>

    <div class="card">
        <h3>Histórico <button onclick="limparHistorico()" style="background:var(--danger); font-size:10px; width:auto; padding:3px 8px;">Zerar</button></h3>
        <div id="historico" class="history">Nenhum registro.</div>
    </div>
</div>

<script>
    let ultimosResultados = { entrada: [], saida: [], tm: 0 };
    let displayUnitIn = "Ω"; // Padrão
    let displayUnitOut = "Ω"; // Padrão

    function calcular() {
        const tm = parseFloat(document.getElementById("tm").value.replace(',', '.'));
        if(isNaN(tm)) { alert("Insira a temperatura medida!"); return; }

        const T = 235; const Tr = 75; const K = 1.5;
        const Ftemp = (T + Tr) / (T + tm);
        
        const ui = parseFloat(document.getElementById("unitIn").value);
        const us = parseFloat(document.getElementById("unitOut").value);

        const processar = (id, mult) => {
            let val = document.getElementById(id).value.replace(',', '.');
            return val === "" ? null : (parseFloat(val) * mult) * K * Ftemp;
        };

        ultimosResultados = {
            tm: tm,
            entrada: [
                { lab: "H1-H3", val: processar("e1", ui) },
                { lab: "H1-H2", val: processar("e2", ui) },
                { lab: "H2-H3", val: processar("e3", ui) }
            ],
            saida: [
                { lab: "X0-X1", val: processar("s1", us) },
                { lab: "X0-X2", val: processar("s2", us) },
                { lab: "X0-X3", val: processar("s3", us) }
            ],
            data: new Date().toLocaleString()
        };

        atualizarTela();
        salvarNoHistorico();
    }

    function atualizarTela() {
        let html = "";
        const formatar = (v, unit) => unit === "mΩ" ? (v * 1000).toFixed(4) + " mΩ" : v.toFixed(6) + " Ω";

        ultimosResultados.entrada.forEach(i => {
            if(i.val !== null) html += `<div class="res-line"><b>${i.lab}:</b> ${formatar(i.val, displayUnitIn)}</div>`;
        });
        ultimosResultados.saida.forEach(i => {
            if(i.val !== null) html += `<div class="res-line"><b>${i.lab}:</b> ${formatar(i.val, displayUnitOut)}</div>`;
        });

        document.getElementById("resFinal").innerHTML = html;
        document.getElementById("areaResultados").style.display = "block";
    }

    function toggleDisplayUnit(tipo) {
        if(tipo === 'In') displayUnitIn = displayUnitIn === "Ω" ? "mΩ" : "Ω";
        else displayUnitOut = displayUnitOut === "Ω" ? "mΩ" : "Ω";
        atualizarTela();
    }

    function limpar() {
        ["tm","e1","e2","e3","s1","s2","s3"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("areaResultados").style.display = "none";
    }

    function salvarNoHistorico() {
        let hist = JSON.parse(localStorage.getItem("ttr_alpha_hist") || "[]");
        hist.unshift(ultimosResultados);
        if(hist.length > 10) hist.pop();
        localStorage.setItem("ttr_alpha_hist", JSON.stringify(hist));
        carregarHistorico();
    }

    function carregarHistorico() {
        let hist = JSON.parse(localStorage.getItem("ttr_alpha_hist") || "[]");
        let html = hist.map(h => `<div><b>${h.data}</b> - Temp: ${h.tm}°C</div>`).join("");
        document.getElementById("historico").innerHTML = html || "Nenhum registro.";
    }

    function limparHistorico() { localStorage.removeItem("ttr_alpha_hist"); carregarHistorico(); }

    async function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text("Relatorio de Ensaio de Resistencia - Equipe Alpha", 10, 20);
        doc.setFontSize(12);
        doc.text(`Data: ${ultimosResultados.data}`, 10, 30);
        doc.text(`Temperatura Medida: ${ultimosResultados.tm} C`, 10, 37);

        const dadosTabela = [];
        ultimosResultados.entrada.concat(ultimosResultados.saida).forEach(item => {
            if(item.val !== null) {
                dadosTabela.push([item.lab, item.val.toFixed(6) + " Ohms", (item.val * 1000).toFixed(4) + " mOhms"]);
            }
        });

        doc.autoTable({
            startY: 45,
            head: [['Enrolamento', 'Resultado (Ohms)', 'Resultado (milliOhms)']],
            body: dadosTabela,
        });

        doc.save(`ensaio_ttr_${Date.now()}.pdf`);
    }

    window.onload = carregarHistorico;
</script>

</body>
</html>
