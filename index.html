<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha TTR - Custom Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Variáveis de Cores (Padrão: Dark Blue) */
        :root { 
            --bg: #121212; --card: #1e1e1e; --primary: #3d5afe; 
            --text: #ffffff; --input-bg: #2a2a2a; --border: #333;
        }

        /* Temas */
        .theme-green { --primary: #00c853; --bg: #0b1a0f; }
        .theme-orange { --primary: #ff6d00; --bg: #1a140b; }
        .theme-classic { --primary: #0d47a1; --bg: #f4f7f9; --text: #333; --card: #fff; --input-bg: #fff; --border: #ddd; }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; }
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid var(--border); position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Menu Lateral (Drawer) */
        .drawer { 
            position: fixed; top: 0; right: -300px; width: 300px; height: 100%; 
            background: var(--card); border-left: 2px solid var(--primary); 
            z-index: 1000; transition: 0.4s; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }
        .drawer.active { right: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }

        .menu-dots { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 28px; color: var(--primary); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; background: var(--input-bg); 
            border: 1px solid var(--border); border-radius: 8px; color: var(--text); 
        }
        
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-calc { background: var(--primary); width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-clear { background: #555; }
        .btn-pdf { background: #673ab7; }
        
        .res-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .res-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border-top: 3px solid var(--primary); }
        .res-line { padding: 8px 0; border-bottom: 1px solid var(--border); font-family: monospace; color: var(--primary); font-weight: bold; }

        /* Estilo Histórico e Cores */
        .hist-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; border-left: 3px solid var(--primary); }
        .color-opt { display: inline-block; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin: 5px; border: 2px solid white; }
    </style>
</head>
<body id="body">

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="drawer" id="drawer">
    <h3>Configurações</h3>
    <p>Temas de Cores:</p>
    <div class="color-opt" style="background:#3d5afe" onclick="setTheme('default')"></div>
    <div class="color-opt" style="background:#00c853" onclick="setTheme('green')"></div>
    <div class="color-opt" style="background:#ff6d00" onclick="setTheme('orange')"></div>
    <div class="color-opt" style="background:#0d47a1" onclick="setTheme('classic')"></div>
    
    <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">
    
    <h3>Histórico</h3>
    <div id="listaHist">Nenhum ensaio salvo.</div>
    <button onclick="limparHistorico()" style="background:red; width:100%; margin-top:10px; padding:5px">Limpar Histórico</button>
</div>

<div class="container">
    <div class="card">
        <div class="menu-dots" onclick="toggleMenu()">&#8942;</div>
        <header>
            <h1 style="margin:0; color:var(--primary)">EQUIPE ALPHA</h1>
            <p style="font-size:13px; opacity:0.7">Controle de Resistência de Enrolamento</p>
        </header>

        <label>Temperatura Medida (°C)</label>
        <input id="tm" type="number" step="0.1" value="25">

        <div class="grid">
            <section>
                <h3 style="color:var(--primary)">Entrada</h3>
                <select id="unitIn">
                    <option value="1e-12">pico-ohms (pΩ)</option>
                    <option value="1e-6">micro-ohms (µΩ)</option>
                    <option value="1e-3">milli-ohms (mΩ)</option>
                    <option value="1" selected>Ohms (Ω)</option>
                </select>
                <input id="e1" type="text" placeholder="H1-H3">
                <input id="e2" type="text" placeholder="H1-H2">
                <input id="e3" type="text" placeholder="H2-H3">
            </section>

            <section>
                <h3 style="color:var(--primary)">Saída</h3>
                <select id="unitOut">
                    <option value="1e-6">micro-ohms (µΩ)</option>
                    <option value="1e-3" selected>milli-ohms (mΩ)</option>
                    <option value="1">Ohms (Ω)</option>
                </select>
                <input id="s1" type="text" placeholder="X0-X1">
                <input id="s2" type="text" placeholder="X0-X2">
                <input id="s3" type="text" placeholder="X0-X3">
            </section>
        </div>

        <button class="btn-calc" onclick="calcular()">CALCULAR RESULTADOS</button>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
            <button class="btn-clear" onclick="limpar()">LIMPAR CAMPOS</button>
            <button class="btn-pdf" onclick="gerarPDF()">EXPORTAR PDF</button>
        </div>
    </div>

    <div class="res-container" id="areaResultados" style="display:none;">
        <div class="res-box">
            <h4>Entrada Corrigida <button onclick="trocarEscala('In')" style="background:none; color:var(--primary); border:none; cursor:pointer; font-size:10px">[Mudar Unidade]</button></h4>
            <div id="resEntrada"></div>
        </div>
        <div class="res-box">
            <h4>Saída Corrigida <button onclick="trocarEscala('Out')" style="background:none; color:var(--primary); border:none; cursor:pointer; font-size:10px">[Mudar Unidade]</button></h4>
            <div id="resSaida"></div>
        </div>
    </div>
</div>

<script>
    let dadosAtuais = null;
    let escalas = [{l:"µΩ", v:1e-6}, {l:"mΩ", v:1e-3}, {l:"Ω", v:1}, {l:"kΩ", v:1e3}];
    let idxIn = 2; let idxOut = 1;

    function toggleMenu() {
        document.getElementById('drawer').classList.toggle('active');
        document.getElementById('overlay').style.display = 
            document.getElementById('overlay').style.display === 'block' ? 'none' : 'block';
    }

    function setTheme(theme) {
        const body = document.getElementById('body');
        body.className = '';
        if(theme !== 'default') body.classList.add('theme-' + theme);
        localStorage.setItem('alpha_theme', theme);
    }

    function calcular() {
        const tm = parseFloat(document.getElementById('tm').value.replace(',', '.'));
        const fTemp = (235 + 75) / (235 + tm);
        const k = 1.5;

        const lerVal = (id, unit) => {
            let v = document.getElementById(id).value.replace(',', '.');
            return v === "" ? null : (parseFloat(v) * unit) * k * fTemp;
        };

        const uIn = parseFloat(document.getElementById('unitIn').value);
        const uOut = parseFloat(document.getElementById('unitOut').value);

        dadosAtuais = {
            tm: tm,
            data: new Date().toLocaleString(),
            entrada: [
                {lab: "H1-H3", val: lerVal('e1', uIn)},
                {lab: "H1-H2", val: lerVal('e2', uIn)},
                {lab: "H2-H3", val: lerVal('e3', uIn)}
            ],
            saida: [
                {lab: "X0-X1", val: lerVal('s1', uOut)},
                {lab: "X0-X2", val: lerVal('s2', uOut)},
                {lab: "X0-X3", val: lerVal('s3', uOut)}
            ]
        };

        render();
        salvar();
        document.getElementById('areaResultados').style.display = 'grid';
    }

    function render() {
        const fmt = (v, esc) => v === null ? "---" : (v / esc.v).toFixed(4) + " " + esc.l;
        document.getElementById('resEntrada').innerHTML = dadosAtuais.entrada.map(i => `<div class="res-line">${i.lab}: ${fmt(i.val, escalas[idxIn])}</div>`).join("");
        document.getElementById('resSaida').innerHTML = dadosAtuais.saida.map(i => `<div class="res-line">${i.lab}: ${fmt(i.val, escalas[idxOut])}</div>`).join("");
    }

    function trocarEscala(t) {
        if(t === 'In') idxIn = (idxIn + 1) % escalas.length;
        else idxOut = (idxOut + 1) % escalas.length;
        render();
    }

    function salvar() {
        let h = JSON.parse(localStorage.getItem('alpha_h') || "[]");
        h.unshift(dadosAtuais);
        localStorage.setItem('alpha_h', JSON.stringify(h.slice(0,10)));
        carregarHist();
    }

    function carregarHist() {
        let h = JSON.parse(localStorage.getItem('alpha_h') || "[]");
        document.getElementById('listaHist').innerHTML = h.map(x => `
            <div class="hist-item">
                <b>${x.data}</b><br>Temp: ${x.tm}°C | Res: ${(x.entrada[0].val||0).toExponential(2)}Ω
            </div>
        `).join("");
    }

    function limpar() { 
        ["tm","e1","e2","e3","s1","s2","s3"].forEach(id => document.getElementById(id).value = ""); 
        document.getElementById('areaResultados').style.display='none';
    }

    function limparHistorico() { localStorage.removeItem('alpha_h'); carregarHist(); }

    function gerarPDF() {
        if(!dadosAtuais) return alert("Calcule antes de exportar.");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("RELATORIO ALPHA TTR", 10, 15);
        doc.text(`Data: ${dadosAtuais.data} | Temp: ${dadosAtuais.tm}C`, 10, 25);
        
        let rows = [];
        dadosAtuais.entrada.concat(dadosAtuais.saida).forEach(i => {
            if(i.val) rows.push([i.lab, i.val.toFixed(6) + " Ω"]);
        });
        doc.autoTable({startY: 35, head: [['Ponto', 'Resultado Corrigido']], body: rows});
        doc.save(`TTR_Alpha_${Date.now()}.pdf`);
    }

    window.onload = () => { 
        carregarHist(); 
        if(localStorage.getItem('alpha_theme')) setTheme(localStorage.getItem('alpha_theme'));
    };
</script>
</body>
</html>
