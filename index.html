<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha TTR - Pro Custom</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Variáveis Dinâmicas Controladas pelo Usuário */
        :root { 
            --bg-color: #121212; 
            --card-bg: #1e1e1e; 
            --primary-color: #3d5afe; 
            --text-color: #ffffff; 
            --border-color: #333333;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; transition: background 0.3s, color 0.3s; }
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid var(--border-color); position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Drawer Lateral */
        .drawer { 
            position: fixed; top: 0; right: -320px; width: 320px; height: 100%; 
            background: var(--card-bg); border-left: 2px solid var(--primary-color); 
            z-index: 1000; transition: 0.4s; padding: 20px; box-sizing: border-box; overflow-y: auto; color: var(--text-color);
        }
        .drawer.active { right: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; }

        .menu-dots { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 28px; color: var(--primary-color); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        label { display: block; font-size: 13px; margin-top: 10px; opacity: 0.8; }
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border-color); border-radius: 8px; color: inherit; box-sizing: border-box;
        }
        
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-calc { background: var(--primary-color); width: 100%; font-size: 16px; margin: 15px 0; }
        
        .res-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .res-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border-top: 4px solid var(--primary-color); }
        .res-line { padding: 10px 0; border-bottom: 1px solid var(--border-color); font-family: 'Courier New', monospace; font-size: 14px; }

        /* Configurações de Cores */
        .config-item { margin-bottom: 15px; }
        .config-item label { display: inline-block; width: 120px; }
        .color-picker { vertical-align: middle; cursor: pointer; }
        
        .hist-item { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 11px; border-left: 3px solid var(--primary-color); }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="drawer" id="drawer">
    <h3>Design e Cores</h3>
    <div class="config-item">
        <label>Cor de Fundo:</label>
        <input type="color" id="cpBg" class="color-picker" oninput="updateColors()">
    </div>
    <div class="config-item">
        <label>Cor do Card:</label>
        <input type="color" id="cpCard" class="color-picker" oninput="updateColors()">
    </div>
    <div class="config-item">
        <label>Cor dos Textos:</label>
        <input type="color" id="cpText" class="color-picker" oninput="updateColors()">
    </div>
    <div class="config-item">
        <label>Cor Principal:</label>
        <input type="color" id="cpPrimary" class="color-picker" oninput="updateColors()">
    </div>
    
    <hr style="border:0; border-top:1px solid var(--border-color); margin: 20px 0;">
    
    <h3>Histórico</h3>
    <div id="listaHist">Nenhum ensaio salvo.</div>
    <button onclick="limparHistorico()" style="background:#ff3d00; width:100%; margin-top:10px; padding:8px; font-size:12px">Limpar Histórico</button>
</div>

<div class="container">
    <div class="card">
        <div class="menu-dots" onclick="toggleMenu()">&#8942;</div>
        <header>
            <h1 style="margin:0; color:var(--primary-color)">EQUIPE ALPHA</h1>
            <p style="font-size:13px; opacity:0.7">Controle de Resistência de Enrolamento</p>
        </header>

        <label>Temperatura Medida (°C)</label>
        <input id="tm" type="number" step="0.1" value="25">

        <div class="grid">
            <section>
                <h3 style="color:var(--primary-color)">Entrada</h3>
                <select id="unitIn">
                    <option value="1e-12">pico-ohms (pΩ)</option>
                    <option value="1e-6">micro-ohms (µΩ)</option>
                    <option value="1e-3">milli-ohms (mΩ)</option>
                    <option value="1" selected>Ohms (Ω)</option>
                </select>
                <input id="e1" type="text" placeholder="Leitura H1-H3">
                <input id="e2" type="text" placeholder="Leitura H1-H2">
                <input id="e3" type="text" placeholder="Leitura H2-H3">
            </section>

            <section>
                <h3 style="color:var(--primary-color)">Saída</h3>
                <select id="unitOut">
                    <option value="1e-6">micro-ohms (µΩ)</option>
                    <option value="1e-3" selected>milli-ohms (mΩ)</option>
                    <option value="1">Ohms (Ω)</option>
                </select>
                <input id="s1" type="text" placeholder="Leitura X0-X1">
                <input id="s2" type="text" placeholder="Leitura X0-X2">
                <input id="s3" type="text" placeholder="Leitura X0-X3">
            </section>
        </div>

        <button class="btn-calc" onclick="calcular()">CALCULAR E SALVAR</button>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button style="background:#444;" onclick="limparCampos()">LIMPAR TELA</button>
            <button style="background:#673ab7;" onclick="gerarPDF()">GERAR PDF</button>
        </div>
    </div>

    <div class="res-container" id="areaResultados" style="display:none;">
        <div class="res-box">
            <h4>Entrada (Corrigida 75°C)</h4>
            <div id="resEntrada"></div>
        </div>
        <div class="res-box">
            <h4>Saída (Corrigida 75°C)</h4>
            <div id="resSaida"></div>
        </div>
    </div>
</div>

<script>
    let dadosSalvos = null;

    function toggleMenu() {
        document.getElementById('drawer').classList.toggle('active');
        document.getElementById('overlay').style.display = 
            document.getElementById('drawer').classList.contains('active') ? 'block' : 'none';
    }

    // Função para atualizar as cores dinamicamente
    function updateColors() {
        const root = document.documentElement;
        root.style.setProperty('--bg-color', document.getElementById('cpBg').value);
        root.style.setProperty('--card-bg', document.getElementById('cpCard').value);
        root.style.setProperty('--text-color', document.getElementById('cpText').value);
        root.style.setProperty('--primary-color', document.getElementById('cpPrimary').value);
        
        // Salvar preferências
        const prefs = {
            bg: document.getElementById('cpBg').value,
            card: document.getElementById('cpCard').value,
            text: document.getElementById('cpText').value,
            primary: document.getElementById('cpPrimary').value
        };
        localStorage.setItem('alpha_theme_prefs', JSON.stringify(prefs));
    }

    function calcular() {
        const tm = parseFloat(document.getElementById('tm').value.replace(',', '.'));
        if(isNaN(tm)) { alert("Insira a temperatura!"); return; }

        const fTemp = (235 + 75) / (235 + tm);
        const k = 1.5;

        // Função de leitura corrigida
        const obter = (id, unit) => {
            let val = document.getElementById(id).value.replace(',', '.');
            if(val === "") return null;
            return (parseFloat(val) * unit) * k * fTemp;
        };

        const uIn = parseFloat(document.getElementById('unitIn').value);
        const uOut = parseFloat(document.getElementById('unitOut').value);

        dadosSalvos = {
            tm: tm,
            data: new Date().toLocaleString(),
            entrada: [
                {lab: "H1-H3", val: obter('e1', uIn)},
                {lab: "H1-H2", val: obter('e2', uIn)},
                {lab: "H2-H3", val: obter('e3', uIn)}
            ],
            saida: [
                {lab: "X0-X1", val: obter('s1', uOut)},
                {lab: "X0-X2", val: obter('s2', uOut)},
                {lab: "X0-X3", val: obter('s3', uOut)}
            ]
        };

        exibirResultados();
        salvarNoHistorico();
    }

    function exibirResultados() {
        const area = document.getElementById('areaResultados');
        const dE = document.getElementById('resEntrada');
        const dS = document.getElementById('resSaida');
        
        area.style.display = 'grid';
        
        dE.innerHTML = dadosSalvos.entrada.map(i => 
            `<div class="res-line"><b>${i.lab}:</b> ${i.val ? i.val.toFixed(6) + " Ω" : "---"}</div>`
        ).join("");

        dS.innerHTML = dadosSalvos.saida.map(i => 
            `<div class="res-line"><b>${i.lab}:</b> ${i.val ? i.val.toFixed(6) + " Ω" : "---"}</div>`
        ).join("");
    }

    function salvarNoHistorico() {
        let h = JSON.parse(localStorage.getItem('alpha_h_pro') || "[]");
        h.unshift(dadosSalvos);
        localStorage.setItem('alpha_h_pro', JSON.stringify(h.slice(0,15)));
        carregarHist();
    }

    function carregarHist() {
        let h = JSON.parse(localStorage.getItem('alpha_h_pro') || "[]");
        document.getElementById('listaHist').innerHTML = h.map(x => `
            <div class="hist-item">
                <b>${x.data}</b><br>Temp: ${x.tm}°C | Medido: ${(x.entrada[0].val || 0).toExponential(2)}Ω
            </div>
        `).join("");
    }

    function limparCampos() {
        ["e1","e2","e3","s1","s2","s3"].forEach(id => document.getElementById(id).value = "");
        document.getElementById('areaResultados').style.display = 'none';
    }

    function limparHistorico() { localStorage.removeItem('alpha_h_pro'); carregarHist(); }

    function gerarPDF() {
        if(!dadosSalvos) return alert("Calcule antes!");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("EQUIPE ALPHA - RELATORIO TTR", 10, 15);
        doc.text(`Data: ${dadosSalvos.data} | Temperatura: ${dadosSalvos.tm}C`, 10, 25);
        let rows = [];
        dadosSalvos.entrada.concat(dadosSalvos.saida).forEach(i => {
            if(i.val) rows.push([i.lab, i.val.toFixed(6) + " Ohms", (i.val*1000).toFixed(4) + " mOhms"]);
        });
        doc.autoTable({startY: 35, head: [['Ponto', 'Res. Ohms', 'Res. mOhms']], body: rows});
        doc.save("ensaio_alpha.pdf");
    }

    // Carregar preferências ao iniciar
    window.onload = () => {
        carregarHist();
        const saved = JSON.parse(localStorage.getItem('alpha_theme_prefs'));
        if(saved) {
            document.getElementById('cpBg').value = saved.bg;
            document.getElementById('cpCard').value = saved.card;
            document.getElementById('cpText').value = saved.text;
            document.getElementById('cpPrimary').value = saved.primary;
            updateColors();
        } else {
            // Valores padrão nos pickers
            document.getElementById('cpBg').value = "#121212";
            document.getElementById('cpCard').value = "#1e1e1e";
            document.getElementById('cpText').value = "#ffffff";
            document.getElementById('cpPrimary').value = "#3d5afe";
        }
    };
</script>
</body>
</html>
