<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha TTR - Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { 
            --bg-body: #121212; --card-bg: #1e1e1e; --primary: #3d5afe; 
            --text: #e0e0e0; --success: #00c853; --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 900px; margin: auto; }
        
        /* Card e Layout */
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; position: relative; }
        header { text-align: center; margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        /* Inputs e Seletor */
        label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        input, select { 
            width: 100%; padding: 12px; margin-bottom: 12px; background: #2a2a2a; 
            border: 1px solid var(--border); border-radius: 6px; color: white; box-sizing: border-box; 
        }
        
        /* Botões */
        .actions { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 10px; }
        button { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-calc { background: var(--primary); }
        .btn-clear { background: #444; }
        .btn-pdf { background: #673ab7; }
        .btn-unit-toggle { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; font-size: 11px; margin-bottom: 10px; }
        
        /* Menu de Histórico (Três Pontos) */
        .menu-hist { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 24px; color: var(--primary); }
        #histContent { display: none; background: #252525; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--primary); }

        /* Resultados */
        .res-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .res-box { background: #252525; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary); }
        .res-line { padding: 8px 0; border-bottom: 1px solid #333; font-family: 'Consolas', monospace; color: var(--success); }
        h3 { margin-top: 0; font-size: 16px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="menu-hist" onclick="toggleHist()">&#8942;</div>
        <header>
            <h1 style="margin:0; color:var(--primary)">EQUIPE ALPHA</h1>
            <p style="font-size:12px; color:#777">Calculadora de Resistência de Enrolamento</p>
        </header>

        <label>Temperatura Medida (°C)</label>
        <input id="tm" type="number" step="0.1" value="25">

        <div class="grid">
            <section>
                <h3>Entrada</h3>
                <select id="unitIn">
                    <option value="1e-12">pico-ohms (pΩ)</option>
                    <option value="1e-9">nano-ohms (nΩ)</option>
                    <option value="1e-6">micro-ohms (µΩ)</option>
                    <option value="1e-3">milli-ohms (mΩ)</option>
                    <option value="1" selected>Ohms (Ω)</option>
                    <option value="1e3">kilo-ohms (kΩ)</option>
                    <option value="1e6">Mega-ohms (MΩ)</option>
                </select>
                <input id="e1" type="text" placeholder="H1-H3">
                <input id="e2" type="text" placeholder="H1-H2">
                <input id="e3" type="text" placeholder="H2-H3">
            </section>

            <section>
                <h3>Saída</h3>
                <select id="unitOut">
                    <option value="1e-12">pico-ohms (pΩ)</option>
                    <option value="1e-9">nano-ohms (nΩ)</option>
                    <option value="1e-6">micro-ohms (µΩ)</option>
                    <option value="1e-3" selected>milli-ohms (mΩ)</option>
                    <option value="1">Ohms (Ω)</option>
                    <option value="1e3">kilo-ohms (kΩ)</option>
                    <option value="1e6">Mega-ohms (MΩ)</option>
                </select>
                <input id="s1" type="text" placeholder="X0-X1">
                <input id="s2" type="text" placeholder="X0-X2">
                <input id="s3" type="text" placeholder="X0-X3">
            </section>
        </div>

        <div class="actions">
            <button class="btn-calc" onclick="calcular()">CALCULAR</button>
            <button class="btn-clear" onclick="limpar()">LIMPAR</button>
            <button class="btn-pdf" onclick="gerarPDF()">GERAR PDF</button>
        </div>

        <div id="histContent">
            <h3>Histórico de Ensaios</h3>
            <div id="listaHist" style="font-size:11px; line-height:1.6">Aguardando dados...</div>
            <button onclick="limparHistorico()" style="background:red; padding:5px; margin-top:10px; font-size:10px">Zerar Histórico</button>
        </div>
    </div>

    <div class="res-container" id="areaResultados" style="display:none;">
        <div class="res-box">
            <h3>Entrada <button class="btn-unit-toggle" onclick="mudarDisplay('In')">Unidade</button></h3>
            <div id="resEntrada"></div>
        </div>
        <div class="res-box">
            <h3>Saída <button class="btn-unit-toggle" onclick="mudarDisplay('Out')">Unidade</button></h3>
            <div id="resSaida"></div>
        </div>
    </div>
</div>

<script>
    let dadosAtuais = { entrada: [], saida: [], tm: 0, data: "" };
    const escalas = [
        { l: "pΩ", v: 1e-12 }, { l: "nΩ", v: 1e-9 }, { l: "µΩ", v: 1e-6 }, 
        { l: "mΩ", v: 1e-3 }, { l: "Ω", v: 1 }, { l: "kΩ", v: 1e3 }, { l: "MΩ", v: 1e6 }
    ];
    let idxIn = 4; // Ω
    let idxOut = 3; // mΩ

    function toggleHist() {
        const h = document.getElementById("histContent");
        h.style.display = h.style.display === "block" ? "none" : "block";
    }

    function calcular() {
        const tm = parseFloat(document.getElementById("tm").value.replace(',', '.'));
        if(isNaN(tm)) return alert("Preencha a temperatura.");

        const Ftemp = (235 + 75) / (235 + tm);
        const K = 1.5;

        const uIn = parseFloat(document.getElementById("unitIn").value);
        const uOut = parseFloat(document.getElementById("unitOut").value);

        // Processamento Individual para evitar valores idênticos
        const obterValores = (prefixo, unidades) => {
            let res = [];
            for(let i=1; i<=3; i++) {
                let id = (prefixo === 'E') ? `e${i}` : `s${i}`;
                let lab = (prefixo === 'E') ? `H1-H${i==1?3:i==2?2:3}` : `X0-X${i}`;
                // Ajuste de label manual para H1-H3, H1-H2, H2-H3 conforme seu padrão
                if(prefixo === 'E') {
                   const labelsEntrada = ["H1-H3", "H1-H2", "H2-H3"];
                   lab = labelsEntrada[i-1];
                }
                
                let raw = document.getElementById(id).value.replace(',', '.');
                let val = raw === "" ? null : (parseFloat(raw) * unidades) * K * Ftemp;
                res.push({ label: lab, val: val });
            }
            return res;
        };

        dadosAtuais = {
            tm: tm,
            entrada: obterValores('E', uIn),
            saida: obterValores('S', uOut),
            data: new Date().toLocaleString()
        };

        document.getElementById("areaResultados").style.display = "grid";
        renderizar();
        salvarHistorico();
    }

    function renderizar() {
        const fmt = (v, esc) => v === null ? "---" : (v / esc.v).toFixed(4) + " " + esc.l;
        
        document.getElementById("resEntrada").innerHTML = dadosAtuais.entrada
            .map(i => `<div class="res-line">${i.label}: ${fmt(i.val, escalas[idxIn])}</div>`).join("");

        document.getElementById("resSaida").innerHTML = dadosAtuais.saida
            .map(i => `<div class="res-line">${i.label}: ${fmt(i.val, escalas[idxOut])}</div>`).join("");
    }

    function mudarDisplay(t) {
        if(t === 'In') idxIn = (idxIn + 1) % escalas.length;
        else idxOut = (idxOut + 1) % escalas.length;
        renderizar();
    }

    function limpar() {
        ["tm","e1","e2","e3","s1","s2","s3"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("areaResultados").style.display = "none";
    }

    function salvarHistorico() {
        let h = JSON.parse(localStorage.getItem("alpha_h") || "[]");
        h.unshift(dadosAtuais);
        localStorage.setItem("alpha_h", JSON.stringify(h.slice(0,10)));
        carregarHist();
    }

    function carregarHist() {
        let h = JSON.parse(localStorage.getItem("alpha_h") || "[]");
        document.getElementById("listaHist").innerHTML = h.map((x, i) => 
            `<div style="border-bottom:1px solid #444; margin-bottom:5px">
                <b>${x.data}</b> - Temp: ${x.tm}°C <br>
                ${x.entrada[0].label}: ${(x.entrada[0].val||0).toExponential(2)} Ω...
            </div>`).join("");
    }

    function limparHistorico() { localStorage.removeItem("alpha_h"); carregarHist(); }

    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16); doc.text("RELATORIO ALPHA TTR", 10, 20);
        doc.setFontSize(10); doc.text(`Data: ${dadosAtuais.data} | Temp: ${dadosAtuais.tm}C`, 10, 30);
        
        const rows = [];
        dadosAtuais.entrada.concat(dadosAtuais.saida).forEach(i => {
            if(i.val) rows.push([i.label, i.val.toFixed(6) + " Ω", (i.val*1000).toFixed(4) + " mΩ"]);
        });

        doc.autoTable({ startY: 40, head: [['Ponto', 'Resultado (Ω)', 'Resultado (mΩ)']], body: rows });
        doc.save("ensaio_alpha.pdf");
    }

    window.onload = carregarHist;
</script>
</body>
</html>
